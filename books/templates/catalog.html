{% extends "base.html" %}

{% block title %}Catalog - Library Application{% endblock %}

{% block nav_catalog %}active{% endblock %}

{% block extra_css %}
<style>
    .book-title {
        cursor: help;
        position: relative;
    }
    .book-title:hover {
        color: #667eea;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mt-4">Book Catalog</h1>

<div class="filter-section mt-4">
    <form method="GET" action="{% url 'books:catalog' %}">
        <div class="filter-row">
            <div class="filter-group">
                <label for="genre">Filter by Genre</label>
                <select class="form-control" id="genre" name="genre">
                    <option value="all" {% if current_genre == 'all' %}selected{% endif %}>All Genres</option>
                    {% for value, label in genres %}
                    <option value="{{ value }}" {% if current_genre == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="author">Filter by Author</label>
                <input type="text" class="form-control" id="author" name="author" value="{{ current_author }}" placeholder="Type author name">
            </div>

            <div class="filter-group">
                <label for="order_by">Order By</label>
                <select class="form-control" id="order_by" name="order_by">
                    <option value="title" {% if current_order == 'title' %}selected{% endif %}>Title (A-Z)</option>
                    <option value="author" {% if current_order == 'author' %}selected{% endif %}>Author (A-Z)</option>
                    <option value="year" {% if current_order == 'year' %}selected{% endif %}>Year (Newest First)</option>
                    <option value="genre" {% if current_order == 'genre' %}selected{% endif %}>Genre</option>
                </select>
            </div>

            <div class="filter-group">
                <button type="submit" class="btn btn-primary btn-block">Apply Filters</button>
            </div>

            <div class="filter-group">
                <a href="{% url 'books:catalog' %}" class="btn btn-secondary btn-block">Clear</a>
            </div>
        </div>
    </form>
</div>

<table class="table table-striped table-hover">
    <thead class="thead-dark">
        <tr>
            <th scope="col">ID</th>
            <th scope="col">Title</th>
            <th scope="col">Author</th>
            <th scope="col">Genre</th>
            <th scope="col">Year</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
        {% for b in books %}
        <tr>
            <th scope="row">{{forloop.counter}}</th>
            <td class="book-title" data-toggle="tooltip" data-placement="top" title="{{b.description|default:'No description available'}}">{{b.title}}</td>
            <td>{{b.author}}</td>
            <td><span class="badge badge-info">{{b.get_genre_display}}</span></td>
            <td>{{b.year}}</td>
            <td>
                {% if user.user_type == 'librarian' %}
                    <a href="{% url 'books:edit-book' book_id=b.id %}"><button type="button" class="btn btn-warning btn-sm">Edit</button></a>
                    <a href="{% url 'books:delete-book' book_id=b.id %}"><button type="button" class="btn btn-danger btn-sm" onclick="return confirm('Delete this book?')">Delete</button></a>
                {% else %}
                    {% if b.id in user_read_books %}
                        <span class="badge badge-success">Already Read</span>
                    {% else %}
                        <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#ratingModal{{ b.id }}">Mark as Read</button>
                    {% endif %}
                {% endif %}
            </td>
        </tr>

        {% if user.user_type == 'reader' and b.id not in user_read_books %}
        <!-- Rating Modal for Book {{ b.id }} -->
        <div class="modal fade" id="ratingModal{{ b.id }}" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Rate "{{ b.title }}"</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <form method="POST" action="{% url 'books:mark-as-read' book_id=b.id %}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <p>Please rate this book before marking it as read:</p>
                            <div class="form-group">
                                <label>Rating (1-5 stars)</label>
                                <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                    <label class="btn btn-outline-warning flex-fill">
                                        <input type="radio" name="rating" value="1" required> 1★
                                    </label>
                                    <label class="btn btn-outline-warning flex-fill">
                                        <input type="radio" name="rating" value="2" required> 2★
                                    </label>
                                    <label class="btn btn-outline-warning flex-fill">
                                        <input type="radio" name="rating" value="3" required> 3★
                                    </label>
                                    <label class="btn btn-outline-warning flex-fill">
                                        <input type="radio" name="rating" value="4" required> 4★
                                    </label>
                                    <label class="btn btn-outline-warning flex-fill">
                                        <input type="radio" name="rating" value="5" required> 5★
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Submit Rating</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        {% empty %}
        <tr>
            <td colspan="6" class="text-center">No books available.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
</script>
{% endblock %}